# https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html
- name: AWS
  hosts: all
  gather_facts: true
  vars_files:
    - ../vars/main.yml

  tasks:
  # -------------------------------------------------------------------------- #
  #               ------- Dependencies ------
  # -------------------------------------------------------------------------- #
  - name: Dependencies
    block:

    - name: Show dependencies
      tags: [init, update]
      ansible.builtin.debug:
        msg: "Dependencies: {{ aws_dependencies }}"

    # sudo apt update -y && sudo apt install -y
    - name: Install dependencies
      tags: init
      ansible.builtin.apt:
        name: "{{ aws_dependencies }}"
        state: present
        update_cache: true

    # sudo apt update -y && sudo apt upgrade -y
    - name: Upgrade dependencies
      tags: update
      ansible.builtin.apt:
        name: "{{ aws_dependencies }}"
        state: latest
        update_cache: true

  # -------------------------------------------------------------------------- #
  #               ------- Installation ------
  # -------------------------------------------------------------------------- #
  - name: Installation
    tags: [init, update]
    block:

    # curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
    # unzip awscliv2.zip
    - name: Download the installer
      ansible.builtin.unarchive:
        src: "https://awscli.amazonaws.com/awscli-exe-{{ ansible_system | lower }}-{{ ansible_architecture }}.zip"
        dest: "/tmp"
        remote_src: true
        creates: "/tmp/aws"
        mode: 0755

    # sudo ./aws/install
    - name: Run the installer
      ansible.builtin.command:
      args:
        cmd: "/tmp/aws/install"
        creates: /usr/local/bin/aws

    - name: Delete installation directory
      ansible.builtin.file:
        path: /tmp/aws
        state: absent

  # -------------------------------------------------------------------------- #
  #               ------- Configuration ------
  # -------------------------------------------------------------------------- #
  - name: Configuration
    become_user: "{{ ansible_user_id }}"
    tags: init
    ansible.builtin.shell:
      cmd: aws configure set {{ item.key }} {{ item.value }} --profile {{ aws_profile }}
    no_log: True
    with_dict:
      region: "{{ aws_region }}"
      format: "{{ aws_format }}"
      sso_account_id: "{{ aws_sso_account_id }}"
      sso_region: "{{ aws_sso_region }}"
      sso_registration_scopes: "{{ aws_sso_registration_scopes }}"
      sso_role_name: "{{ aws_sso_role_name }}"
      sso_start_url: "{{ aws_sso_start_url }}"

  # -------------------------------------------------------------------------- #
  #               ------- Version ------
  # -------------------------------------------------------------------------- #
  - name: Version
    tags: [init, update]
    block:

    - name: Confirm version
      ansible.builtin.command:
        cmd: aws --version
      register: version
      changed_when: false

    - name: Show version
      when: version is defined
      ansible.builtin.debug:
        msg: "Installed version: {{ version.stdout }}"
